// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------------------------------------------
// 1. O USU√ÅRIO (VOC√ä/PRESTADOR)
// ------------------------------------------------------
model User {
  id        String   @id // ID do Clerk (ex: user_2b9...)
  email     String   @unique
  name      String?
  
  // -- Identidade Visual e Marca --
  companyName String?  // Nome fantasia (ex: Silva El√©trica)
  logoUrl     String?  // URL da imagem da logomarca
  themeColor  String   @default("#2563EB") // Cor principal do PDF (Azul padr√£o)
  
  // -- Dados de Contato e Endere√ßo --
  phone       String?  // WhatsApp para sair no or√ßamento
  address     String?  // Endere√ßo comercial
  cpfCnpj     String?

  // -- Financeiro (Para receber do cliente) --
  pixKey      String?  // A chave PIX
  pixHolder   String?  // Nome do titular da conta (passa credibilidade)
  bankDetails String?  // Ag√™ncia/Conta (opcional)

  // -- Configura√ß√µes --
  signature   String?  @default("Agradecemos a prefer√™ncia! Or√ßamento v√°lido por 15 dias.")
  
  // -- Futuro: Assinatura SaaS (Monetiza√ß√£o) --
  plan             Plan     @default(FREE)
  stripeCustomerId String?  // ID do cliente no Stripe/Asaas
  credits          Int      @default(10) // Limite de or√ßamentos no plano Free

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  proposals Proposal[]
  clients   Client[]   // Seu CRM de clientes
}

// ------------------------------------------------------
// 2. O CLIENTE (CRM) - FUTURO üîÆ
// ------------------------------------------------------
// Salva os clientes para reuso. "Ah, vou fazer outro servi√ßo pra Dona Maria."
model Client {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  address   String?
  notes     String?  // Obs: "Cliente chato" ou "Paga em dia"

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  proposals Proposal[] // Hist√≥rico de or√ßamentos deste cliente

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ------------------------------------------------------
// 3. O OR√áAMENTO (PROPOSTA)
// ------------------------------------------------------
model Proposal {
  id          String   @id @default(cuid())
  publicId    String   @unique @default(cuid()) // Token para link p√∫blico (fechou.ai/p/XyZ...)
  
  // Dados do Servi√ßo
  title       String   // T√≠tulo gerado pela IA (ex: "Instala√ß√£o de Chuveiro")
  description String?  @db.Text
  
  // Valores
  totalAmount Decimal  @db.Decimal(10, 2) // Melhor que Float para dinheiro
  validity    Int      @default(15) // Dias de validade

  // Conte√∫do Original (Auditoria da IA)
  audioUrl      String?
  transcription String? @db.Text // O que o usu√°rio falou
  
  // Status (Workflow)
  status      ProposalStatus @default(DRAFT)
  viewCount   Int            @default(0) // Quantas vezes o cliente abriu o link

  // Relacionamentos
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])

  items       ProposalItem[] // Lista de itens detalhada

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// ------------------------------------------------------
// 4. ITENS DO OR√áAMENTO (DETALHES)
// ------------------------------------------------------
// Permite saber quanto √© pe√ßa e quanto √© m√£o de obra
model ProposalItem {
  id          String   @id @default(cuid())
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)
  
  // Tipo do item (Material ou Servi√ßo?)
  type        ItemType @default(SERVICE)

  proposalId  String
  proposal    Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
}

// ------------------------------------------------------
// ENUMS (OP√á√ïES PADRONIZADAS DO POSTGRES)
// ------------------------------------------------------
enum Plan {
  FREE
  PRO
  ENTERPRISE
}

enum ProposalStatus {
  DRAFT     // Rascunho
  SENT      // Enviado (Link gerado)
  VIEWED    // Cliente viu
  APPROVED  // Fechou!
  REJECTED  // N√£o fechou
  PAID      // Dinheiro na conta
}

enum ItemType {
  SERVICE   // M√£o de obra
  MATERIAL  // Pe√ßas
  OTHER
}